<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>五臟廟-愛吃熊</title>

  <!-- PWA / Icon 設定 -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <meta name="theme-color" content="#f4a63a">

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- 啟動畫面：進來時先看到熊熊整張圖 -->
  <div id="loading-screen">
    <img src="images/bear-loading-couplet.png" alt="愛吃熊啟動畫面">
  </div>

  <!-- 右上角：功德值角標 -->
  <div class="merit-badge">
    功德值 <span id="merit">0</span>
  </div>

  <div class="app">
    <!-- 標題 -->
    <header class="header">
      <div class="title">愛吃熊美食占卜</div>
      <div class="subtitle">不是正在吃美食，就是在吃美食的路上</div>
    </header>

    <!-- 主視覺：完整熊熊原圖（不裁切） -->
    <section class="temple-wrapper">
      <img src="images/bear-loading-couplet.png"
           alt="愛吃熊與美食"
           class="temple-image" />
      <!-- 熊熊祝福對話氣泡（上供品用） -->
      <div id="bearBubble" class="bear-bubble"></div>
    </section>

    <!-- 狀態提示文字 -->
    <p id="statusText" class="status-text">
      請先擲筊，一次聖筊就可以抽籤。
    </p>

    <!-- 抽籤按鈕：小奶油色 pill -->
    <section class="draw-row">
      <button id="drawBtn" class="pill-btn draw-btn hidden">
        🧧 抽籤
      </button>
    </section>

    <!-- 下方四顆奶油色圓形大按鈕 -->
    <section class="round-button-row">
      <button id="boBtn" class="round-btn">
        🙏<span>擲筊</span>
      </button>

      <button id="offerBtn" class="round-btn">
        🍱<span>上供品</span>
      </button>

      <button id="historyBtn" class="round-btn">
        📘<span>抽籤紀錄</span>
      </button>

      <button id="igBtn" class="round-btn">
        📸<span>追蹤 IG</span>
      </button>
    </section>

    <!-- 目前詩籤卡片（中繼容器，實際顯示改為彈窗） -->
    <section id="currentLotCard" class="lot-card hidden"></section>
  </div>

  <!-- 詩籤彈窗（大一點＋詩籤排版） -->
  <div id="lotModal" class="modal hidden"
       onclick="if (event.target === this) window.closeAllModals();">
    <div class="modal-content">
      <div id="lotText"></div>
      <button id="closeLot" class="close-btn"
              onclick="window.closeAllModals();">
        關閉
      </button>
    </div>
  </div>

  <!-- 抽籤紀錄彈窗（script.js 會填內容） -->
  <div id="historyModal" class="modal hidden"
       onclick="if (event.target === this) window.closeAllModals();">
    <div class="modal-content">
      <div id="historyList"></div>
      <button id="closeHistory" class="close-btn"
              onclick="window.closeAllModals();">
        關閉
      </button>
    </div>
  </div>

  <!-- 原本的邏輯檔 -->
  <script src="script.js"></script>

  <!-- 額外 UI / 動畫 / 詩籤視窗邏輯 -->
  <script>
    /* --- 啟動畫面淡出 --- */
    function hideLoadingScreen() {
      const loading = document.getElementById('loading-screen');
      if (!loading) return;
      loading.classList.add('fade-out');
      setTimeout(() => loading.remove(), 700);
    }

    window.addEventListener('load', hideLoadingScreen);
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(hideLoadingScreen, 1800);
    });

    /* --- 愛吃熊祝福語（供品用） --- */
    const BEAR_BLESSINGS = [
      "愛吃熊送你一口好心情，記得慢慢吃、好好吃。",
      "你今天辛苦了，給自己一份好吃的，就會更有力量喔！",
      "肚子被照顧好，心情也會跟著變甜甜的。",
      "願每一餐都能安慰你，愛吃熊陪你一起吃好料。",
      "好好吃飯不是奢侈，是一種對自己的溫柔。",
      "吃飽的人最可愛，願你今天也是可愛的。",
      "愛吃熊祝福你：每一口都剛剛好、每一步都順順的。",
      "不用勉強微笑，先吃好吃的，笑容就會自然跑出來。",
      "給自己一口溫暖，世界就會變得沒那麼可怕。",
      "願你的肚子飽飽、心也暖暖，今天辛苦的都值得。",
      "愛吃熊提醒你：好好吃飯，是最簡單的幸福魔法。",
      "願你每一餐都能療癒自己，而不是勉強自己。",
      "你值得被好好餵飽，也值得被好好對待。",
      "吃東西時請放鬆，剩下的事交給明天的你就好。",
      "願好的味道陪著你，把壞心情一點一點融化掉。",
      "愛吃熊給你一個抱抱，再給你一份好吃的。",
      "願你的碗裡永遠裝著安心、期待與小小的快樂。",
      "如果覺得累，那就先吃好吃的，愛吃熊會陪著你。"
    ];

    /* --- 愛吃熊建議（詩籤視窗用）--- */
    const BEAR_ADVICE = [
      "今天先照顧好肚子，再去面對那些讓你緊張的事情就好。",
      "慢慢吃、慢慢想，不用一次把所有答案都找出來。",
      "如果覺得心裡亂，就先從一頓好好吃的餐開始整理生活。",
      "允許自己挑一個真的想吃的，而不是「應該吃」的東西。",
      "吃飯時專心享受味道，就是在好好陪伴自己。",
      "你已經很努力了，給自己一點喜歡的食物當小獎勵吧。"
    ];

    function getRandomAdvice() {
      return BEAR_ADVICE[
        Math.floor(Math.random() * BEAR_ADVICE.length)
      ];
    }

    /* --- 功德值：只會增加，不會減少 --- */
    window.addMerit = function (delta) {
      if (!delta || delta <= 0) return;

      const badgeValue = document.getElementById('merit');
      if (!badgeValue) return;

      const current = parseInt(badgeValue.textContent || '0', 10);
      const next = current + delta;
      badgeValue.textContent = next;

      const badge = document.querySelector('.merit-badge');
      if (!badge) return;

      const plus = document.createElement('span');
      plus.className = 'merit-plus';
      plus.textContent = '+' + delta;
      badge.appendChild(plus);

      setTimeout(() => plus.remove(), 900);
    };

    /* --- 熊熊祝福氣泡（上供品顯示） --- */
    function showBearBlessing() {
      const bubble = document.getElementById('bearBubble');
      if (!bubble) return;

      const msg =
        BEAR_BLESSINGS[Math.floor(Math.random() * BEAR_BLESSINGS.length)];
      bubble.textContent = msg;

      bubble.classList.remove('show');
      void bubble.offsetWidth; // 強制重繪
      bubble.classList.add('show');
    }

    /* --- 關閉所有彈窗 --- */
    window.closeAllModals = function () {
      const lotModal = document.getElementById('lotModal');
      const historyModal = document.getElementById('historyModal');
      if (lotModal) lotModal.classList.add('hidden');
      if (historyModal) historyModal.classList.add('hidden');
    };

    /* --- DOM 載入後的額外處理 --- */
    document.addEventListener('DOMContentLoaded', () => {
      const offerBtn = document.getElementById('offerBtn');
      const igBtn = document.getElementById('igBtn');
      const historyBtn = document.getElementById('historyBtn');
      const boBtn = document.getElementById('boBtn');

      /* 上供品：永遠可以按，按一次 +1 功德 + 祝福 */
      if (offerBtn) {
        offerBtn.disabled = false;
        offerBtn.classList.remove('disabled');
        offerBtn.addEventListener('click', () => {
          window.addMerit(1);
          showBearBlessing();
        });
      }

      /* 追蹤 IG：開啟 IG 連結 */
      if (igBtn) {
        igBtn.addEventListener('click', () => {
          window.open('https://instagram.com/luckygbear', '_blank');
        });
      }

      /* 抽籤紀錄按鈕：script.js 會負責打開 #historyModal */
      if (historyBtn) historyBtn.classList.remove('hidden');
      if (boBtn) boBtn.classList.remove('hidden');

      /* --- 詩籤卡變化 -> 顯示詩籤彈窗 --- */
      const lotCard = document.getElementById('currentLotCard');
      const lotModal = document.getElementById('lotModal');
      const lotText = document.getElementById('lotText');
      const historyModal = document.getElementById('historyModal');

      if (lotCard && lotModal && lotText) {
        const observer = new MutationObserver(() => {
          const rawText = lotCard.innerText.trim();
          if (!rawText) return;

          // 關掉抽籤紀錄視窗，避免遮住詩籤
          if (historyModal) historyModal.classList.add('hidden');

          // 解析原本的詩籤文字
          let lines = rawText.split(/\n+/).map(l => l.trim()).filter(Boolean);

          // 把「(點這裡可再次查看完整詩籤)」這句從內容移除
          lines = lines.filter(line => !line.includes("點這裡可再次查看完整詩籤"));

          const title = lines[0] || "今日美食籤";
          const dish = lines[1] || "好料一份";
          const detailLines = lines.slice(2);
          const detailHtml = detailLines
            .map(l => l.replace(/ /g, "&nbsp;"))
            .join("<br>");

          const poemLines = [
            `${dish}香氣暖心房`,
            "慢慢入口不慌不忙",
            "照顧肚子也是力量",
            "好好吃飯勇氣滿滿"
          ];

          const advice = getRandomAdvice();

          lotText.innerHTML = `
            <div class="lot-modal-card">
              <div class="lot-modal-title">${title}</div>

              <div class="lot-modal-section lot-poem">
                ${poemLines
                  .map(l => `<div class="lot-poem-line">${l}</div>`)
                  .join("")}
              </div>

              <div class="lot-modal-section">
                <div class="lot-section-label">今日吃貨指引</div>
                <div class="lot-section-body">${detailHtml}</div>
              </div>

              <div class="lot-modal-section">
                <div class="lot-section-label">愛吃熊小提醒</div>
                <div class="lot-section-body">${advice}</div>
              </div>
            </div>
          `;

          lotModal.classList.remove('hidden');
          lotCard.classList.add('hidden');
        });

        observer.observe(lotCard, { childList: true, subtree: true });
      }
    });
  </script>
</body>
</html>