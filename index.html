<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>五臟廟-愛吃熊</title>

  <!-- PWA / Icon 設定 -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <meta name="theme-color" content="#f4a63a">

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- 啟動畫面：進來時先看到熊熊整張圖 -->
  <div id="loading-screen">
    <img src="images/bear-loading-couplet.png" alt="愛吃熊啟動畫面">
  </div>

  <!-- 功德值角標：整個畫面的右上角 -->
  <div class="merit-badge">
    功德值 <span id="merit">0</span>
  </div>

  <div class="app">
    <!-- 標題 -->
    <header class="header">
      <div class="title">愛吃熊美食占卜</div>
      <div class="subtitle">不是正在吃美食，就是在吃美食的路上</div>
    </header>

    <!-- 主視覺：熊熊圖當背景 -->
    <section class="temple-wrapper">
      <div class="temple-image-box"></div>
      <!-- 熊熊祝福對話氣泡（用 JS 填文字） -->
      <div id="bearBubble" class="bear-bubble"></div>
    </section>

    <!-- 狀態提示文字（不再顯示聖筊機率） -->
    <p id="statusText" class="status-text">
      請先擲筊，一次聖筊就可以抽籤。
    </p>

    <!-- 三個大按鈕在下方 -->
    <section class="button-row">
      <button id="boBtn" class="main-btn primary">
        🙏 擲筊
      </button>
      <button id="drawBtn" class="main-btn primary hidden">
        🧧 抽籤
      </button>
      <button id="offerBtn" class="main-btn primary">
        🍱 上供品
      </button>
    </section>

    <!-- 次要按鈕：抽籤紀錄 -->
    <section class="button-row secondary">
      <button id="historyBtn" class="sub-btn">
        📘 抽籤紀錄
      </button>
    </section>

    <!-- 目前詩籤卡片：只當中繼容器，實際顯示改為彈窗 -->
    <section id="currentLotCard" class="lot-card hidden"></section>
  </div>

  <!-- 詩籤彈窗 -->
  <div id="lotModal" class="modal hidden"
       onclick="if (event.target === this) window.closeAllModals();">
    <div class="modal-content">
      <div id="lotText"></div>
      <button id="closeLot" class="close-btn"
              onclick="window.closeAllModals();">
        關閉
      </button>
    </div>
  </div>

  <!-- 抽籤 & 功德紀錄彈窗 -->
  <div id="historyModal" class="modal hidden"
       onclick="if (event.target === this) window.closeAllModals();">
    <div class="modal-content">
      <div id="historyList"></div>
      <button id="closeHistory" class="close-btn"
              onclick="window.closeAllModals();">
        關閉
      </button>
    </div>
  </div>

  <!-- 你的原本遊戲邏輯（擲筊 / 抽籤 / 寫紀錄） -->
  <script src="script.js"></script>

  <!-- 啟動畫面、功德動畫、愛吃熊祝福、供品邏輯、籤詩彈窗 -->
  <script>
    /* --- 啟動畫面淡出 --- */
    function hideLoadingScreen() {
      const loading = document.getElementById('loading-screen');
      if (!loading) return;
      loading.classList.add('fade-out');
      setTimeout(() => loading.remove(), 700);
    }

    window.addEventListener('load', hideLoadingScreen);
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(hideLoadingScreen, 1800);
    });

    /* --- 愛吃熊祝福語（18句） --- */
    const BEAR_BLESSINGS = [
      "愛吃熊送你一口好心情，記得慢慢吃、好好吃。",
      "你今天辛苦了，給自己一份好吃的，就會更有力量喔！",
      "肚子被照顧好，心情也會跟著變甜甜的。",
      "願每一餐都能安慰你，愛吃熊陪你一起吃好料。",
      "好好吃飯不是奢侈，是一種對自己的溫柔。",
      "吃飽的人最可愛，願你今天也是可愛的。",
      "愛吃熊祝福你：每一口都剛剛好、每一步都順順的。",
      "不用勉強微笑，先吃好吃的，笑容就會自然跑出來。",
      "給自己一口溫暖，世界就會變得沒那麼可怕。",
      "願你的肚子飽飽、心也暖暖，今天辛苦的都值得。",
      "愛吃熊提醒你：好好吃飯，是最簡單的幸福魔法。",
      "願你每一餐都能療癒自己，而不是勉強自己。",
      "你值得被好好餵飽，也值得被好好對待。",
      "吃東西時請放鬆，剩下的事交給明天的你就好。",
      "願好的味道陪著你，把壞心情一點一點融化掉。",
      "愛吃熊給你一個抱抱，再給你一份好吃的。",
      "願你的碗裡永遠裝著安心、期待與小小的快樂。",
      "如果覺得累，那就先吃好吃的，愛吃熊會陪著你。"
    ];

    /* --- 功德值：只會增加，不會減少 --- */
    window.addMerit = function (delta) {
      if (!delta || delta <= 0) return; // 不接受扣分

      const badgeValue = document.getElementById('merit');
      if (!badgeValue) return;

      const current = parseInt(badgeValue.textContent || '0', 10);
      const next = current + delta;
      badgeValue.textContent = next;

      // 飄出的 +1 動畫
      const badge = document.querySelector('.merit-badge');
      if (!badge) return;

      const plus = document.createElement('span');
      plus.className = 'merit-plus';
      plus.textContent = '+' + delta;
      badge.appendChild(plus);

      setTimeout(() => plus.remove(), 900);
    };

    /* --- 熊熊祝福氣泡 --- */
    function showBearBlessing() {
      const bubble = document.getElementById('bearBubble');
      if (!bubble) return;

      const msg =
        BEAR_BLESSINGS[Math.floor(Math.random() * BEAR_BLESSINGS.length)];
      bubble.textContent = msg;

      bubble.classList.remove('show');
      void bubble.offsetWidth; // 強制重繪
      bubble.classList.add('show');
    }

    /* --- 關閉所有彈窗 --- */
    window.closeAllModals = function () {
      const lotModal = document.getElementById('lotModal');
      const historyModal = document.getElementById('historyModal');
      if (lotModal) lotModal.classList.add('hidden');
      if (historyModal) historyModal.classList.add('hidden');
    };

    /* --- DOM 載入後的額外處理 --- */
    document.addEventListener('DOMContentLoaded', () => {
      /* 1. 上供品：永遠可以按，按一次 +1 功德 + 祝福 */
      const offerBtn = document.getElementById('offerBtn');
      if (offerBtn) {
        offerBtn.disabled = false;
        offerBtn.classList.remove('disabled');
        offerBtn.addEventListener('click', () => {
          window.addMerit(1);
          showBearBlessing();
        });
      }

      /* 2. 確保重要按鈕一定可見 */
      ["boBtn", "historyBtn", "offerBtn"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('hidden');
      });

      /* 3. 監聽目前詩籤卡片內容變化 -> 自動跳出彈窗顯示 */
      const lotCard = document.getElementById('currentLotCard');
      const lotModal = document.getElementById('lotModal');
      const lotText = document.getElementById('lotText');

      if (lotCard && lotModal && lotText) {
        const observer = new MutationObserver(() => {
          const html = lotCard.innerHTML.trim();
          if (!html) return;

          // 把原本塞在下面卡片的內容轉移到彈窗
          lotText.innerHTML = html;
          lotModal.classList.remove('hidden');
          lotCard.classList.add('hidden');
        });

        observer.observe(lotCard, { childList: true, subtree: true });
      }
    });
  </script>
</body>
</html>